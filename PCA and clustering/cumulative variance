import MDAnalysis as mda
from MDAnalysis.analysis import pca, align
import matplotlib.pyplot as plt
import numpy as np
import plotly.graph_objects as go
import plotly.express as px

# 1. Load Universes
u_wt = mda.Universe("wt_protein_only.gro", "wt_protein_only.xtc")
u_af = mda.Universe("af_protein_only.gro", "Alpha_protein_only.xtc")
u_ch = mda.Universe("chimera_protein_only.gro", "chimera_protein_only.xtc")

# 2. Pre-align trajectories to the WT reference structure
# This ensures motions are internal and not just global rotation/translation
ref_atoms = u_wt.select_atoms('name CA')
for u in [u_wt, u_af, u_ch]:
    alignment = align.AlignTraj(u, u_wt, select='name CA', in_memory=True).run()

# 3. Run PCA on the WT to define the "Reference Space"
pc_wt = pca.PCA(u_wt, select='name CA').run()

# Calculate variance for axis labels
var1 = pc_wt.results.cumulated_variance[0] * 100
var2 = (pc_wt.results.cumulated_variance[1] - pc_wt.results.cumulated_variance[0]) * 100
# 1. Prepare data for plotting
# MDAnalysis stores cumulative variance in .results.cumulated_variance
cum_var = pc_wt.results.cumulated_variance
n_components = np.arange(len(cum_var)) + 1  # PCA components are 1-indexed

# 2. Create the Cumulative Variance Plot
fig_var = px.line(
    x=n_components, 
    y=cum_var,
    labels={'x': 'Principal Component', 'y': 'Cumulative Variance'},
    title='Cumulative Explained Variance (WT Reference Space)',
    range_x=[0, 100]  # Focus on the first 100 components
)

# Optional: Add a horizontal line at 70% or 80% to show the "elbow"
fig_var.add_hline(y=0.7, line_dash="dash", annotation_text="70% Variance")

fig_var.show()
