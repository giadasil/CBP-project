import MDAnalysis as mda
from MDAnalysis.analysis import pca, align
import matplotlib.pyplot as plt
import numpy as np
import plotly.graph_objects as go
import pandas as pd
import plotly.express as px

# 1. Load Universes
u_wt = mda.Universe("wt_protein_only.gro", "wt_protein_only.xtc")
u_af = mda.Universe("af_protein_only.gro", "Alpha_protein_only.xtc")
u_ch = mda.Universe("chimera_protein_only.gro", "chimera_protein_only.xtc")

# 2. Pre-align trajectories to the WT reference structure
# This ensures motions are internal and not just global rotation/translation
ref_atoms = u_wt.select_atoms('name CA')
for u in [u_wt, u_af, u_ch]:
    alignment = align.AlignTraj(u, u_wt, select='name CA', in_memory=True).run()

# 3. Run PCA on the WT to define the "Reference Space"
pc_wt = pca.PCA(u_wt, select='name CA').run()

# 2. Project onto 5 components (Required for the cosine content check)
n_comp = 3
wt_proj = pc_wt.transform(u_wt.select_atoms('name CA'), n_components=n_comp)
af_proj = pc_wt.transform(u_af.select_atoms('name CA'), n_components=n_comp)
ch_proj = pc_wt.transform(u_ch.select_atoms('name CA'), n_components=n_comp)

# 3. Define function for cosine content
def calculate_cosine_content(projections, n_components=5):
    # This now matches the shape of the projections above
    return [pca.cosine_content(projections, i) for i in range(n_components)]

# 4. Compute values
cc_wt = calculate_cosine_content(wt_proj, n_components=n_comp)
cc_af = calculate_cosine_content(af_proj, n_components=n_comp)
cc_ch = calculate_cosine_content(ch_proj, n_components=n_comp)

# 5. Plotting
labels = [f'PC{i+1}' for i in range(n_comp)]
x = np.arange(len(labels))
width = 0.25

fig, ax = plt.subplots(figsize=(10, 6))
ax.bar(x - width, cc_wt, width, label='Wild Type', color='#1f77b4')
ax.bar(x, cc_af, width, label='Gln104Ala AF', color='#2ca02c')
ax.bar(x + width, cc_ch, width, label='Gln104Ala Chimera', color="#df081e")

ax.axhline(y=0.5, color='red', linestyle='--', alpha=0.6, label='Random Walk Threshold (0.5)')
ax.set_ylabel('Cosine Content')
ax.set_title('Cosine Content Comparison', fontweight='bold')
ax.set_xticks(x)
ax.set_xticklabels(labels)
ax.set_ylim(0, 1.1)
ax.legend()

plt.grid(axis='y', alpha=0.3)
plt.show()
