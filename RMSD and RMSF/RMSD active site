import MDAnalysis as mda
from MDAnalysis.analysis import rms, align
import matplotlib.pyplot as plt

# 1. Load Universes
u_wt = mda.Universe("wt_protein_only.gro", "wt_protein_only.xtc")
u_af = mda.Universe("af_protein_only.gro", "Alpha_protein_only.xtc")
u_ch = mda.Universe("chimera_protein_only.gro", "chimera_protein_only.xtc")

# 2. Define selections
align_sel = "name CA" 
# Active site: residues 104, Lys27, Arg59, His102
active_site_sel = "resnum 27 59 102 104 and name CA"

# 3. Align all trajectories to the WT crystal structure
# We align on CA to keep the protein centered, then measure local changes
for u in [u_wt, u_af, u_ch]:
    align.AlignTraj(u, u_wt, select=align_sel, in_memory=True).run()

# 4. Calculate RMSD for the active site
# Note: we use u_wt as the fixed reference for all three
R_wt_active = rms.RMSD(u_wt, u_wt, select=active_site_sel, ref_frame=0).run()
R_af_active = rms.RMSD(u_af, u_wt, select=active_site_sel, ref_frame=0).run()
R_ch_active = rms.RMSD(u_ch, u_wt, select=active_site_sel, ref_frame=0).run()

# 5. Plotting local impact
plt.figure(figsize=(10, 5))
time_ns = R_wt_active.results.rmsd[:, 1] / 1000

plt.plot(time_ns, R_wt_active.results.rmsd[:, 2], label="WT Active Site", color='blue')
plt.plot(time_ns, R_af_active.results.rmsd[:, 2], label="AF Mutant Active Site", color='green')
plt.plot(time_ns, R_ch_active.results.rmsd[:, 2], label="Chimera Mutant Active Site", color='red')

plt.ylabel("RMSD (Ã…)")
plt.xlabel("Time (ns)")
plt.title("Local Structural Deviation: Active Site (Res 104 Neighborhood)")
plt.legend()
plt.show()
